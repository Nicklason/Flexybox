@page "/"

@inject DepartmentsService DepartmentsService
@inject FavoriteDepartmentsService FavoriteDepartmentsService

@code {
  private List<(int, string)> departments = new ();
  private List<(int, string)> favoriteDepartments = new ();

  private bool IsLoaded = false;

  protected override async Task OnInitializedAsync() {
    departments = await DepartmentsService.GetAllIdsAndNamesAsync();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender) {
    if (!firstRender) {
      return;
    }

    await LoadStateAsync();
    IsLoaded = true;
    StateHasChanged();
  }

  private async Task LoadStateAsync() {
    var favorites = await FavoriteDepartmentsService.GetLikedAsync();
    favoriteDepartments = departments.Where((department) => favorites.Contains(department.Item2)).ToList();
  }
}

<div class="page">
  <div class="section">
    <div class="subsection">
      <div class="title">
        <h1>Welcome to Flexybook</h1>
      </div>
    </div>
    <div class="subsection">
      <p>Explore departments.</p>
    </div>
    @if (favoriteDepartments.Count != 0) {
    <div class="subsection">
      <h2>Your favorite departments</h2>

      @foreach (var department in favoriteDepartments)
      {
        <NavLink href="@("/department/" + department.Item1)" Match="NavLinkMatch.All">
          @department.Item2
        </NavLink>
      }
    </div>
    }
    <div class="subsection">
      <h2>Featured departments</h2>

      @if (departments.Count == 0)
      {
        <p>No departments available.</p>
      } else {
        @foreach (var department in departments)
        {
          <NavLink href="@("/department/" + department.Item1)" Match="NavLinkMatch.All">
            @department.Item2
          </NavLink>
        }
      }
    </div>
  </div>
</div>
